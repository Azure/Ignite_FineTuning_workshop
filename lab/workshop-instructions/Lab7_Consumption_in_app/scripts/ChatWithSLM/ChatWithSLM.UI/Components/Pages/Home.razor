@page "/"
@rendermode InteractiveServer


@using System
@using System.Collections.Generic
@using System.Net.Http
@using System.Net.Http.Headers
@using System.Threading.Tasks
@using System.Web
@using System.Text.Json
@using ChatWithSLM.UI.Utils;
@inject SLMClient _slm;


<div class="chat-container">
    <div class="messages">
        @foreach (var message in Messages)
        {
            <div class="message @message.Role">
                <div class="message-header">
                    <span class="sender">@(message.Role == "me" ? "Me" : "Bot")</span>
                </div>
                <div class="message-text">@message.Content</div>
            </div>
        }
    </div>
    <div class="input-container">
        <textarea @bind="NewMessage" placeholder="Please write your questions..." class="form-control input-message"></textarea>
        <div class="controls">
            <select @onchange="OnModelChanged" class="form-select auto-width">
                @foreach (var model in Models)
                {
                    <option value="@model">@model</option>
                }
            </select>
            <button @onclick="SendMessage" class="btn btn-primary send-button">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxNCIgdmlld0JveD0iMCAwIDE0IDE0Ij4KPHBhdGggZD0iTTAgMGwxNCA3LjA1TDAgMTRWOC4wNUw5IDcgMCA1LjA1VjB6Ii8+Cjwvc3ZnPgo=" alt="Send" class="send-logo" />
            </button>
        </div>
    </div>
</div>

<style>
    .chat-title {
        width: 95%;
        margin: 0 auto 10px auto; /* Add bottom margin to create space */
        text-align: left;
        font-size: 24px;
        font-weight: bold;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        width: 95%;
        height: 800px;
        border-radius: 5px;
        padding: 10px;
        margin: auto; /* Center horizontally and vertically */
        position: relative;
    }

    .messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        height: 300px; /* Fixed height */
    }

    .message {
        display: flex;
        flex-direction: column;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 5px;
        width: 100%;
        word-wrap: break-word;
    }

    .message.me {
        align-items: flex-end;
    }

    .message.me .message-text {
        background-color: #007bff;
        color: white;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
        text-align: left;
    }

    .message.bot {
        align-items: flex-start;
    }

    .message.bot .message-text {
        background-color: #28a745;
        color: white;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
        text-align: left;
    }

    .message-header {
        font-size: smaller;
        color: gray;
        margin-bottom: 5px;
    }

    .sender {
        font-size: smaller;
        color: gray;
    }

    .input-container {
        display: flex;
        flex-direction: column;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px;
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 160px;
    }

    .form-control.input-message {
        flex: 1;
        height: 140px;
        border: none;
        resize: none;
        margin-bottom: 10px;
    }

    .controls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }

    .form-select.auto-width {
        width: auto;
        margin-right: 20px;
    }

    .send-button {
        background: none;
        border: none;
        padding: 0;
    }

    .send-logo {
        width: 24px;
        height: 24px;
    }
</style>

@code {
    private List<string> Models = new List<string>
    {
        "Phi-3.5-Instruct",
        "Phi-3.5-Finetuning",
        "GPT-3.5-Finetuning",
    };

    private string SelectedModel { get; set; }
    private string NewMessage { get; set; }
    private List<Message> Messages { get; set; } = new List<Message>();
    private List<Message> prompt {get;set;} = new List<Message>();

    private void OnModelChanged(ChangeEventArgs e)
    {
        SelectedModel = e.Value.ToString();
    }

    async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(NewMessage))
        {
            string promptmsg = NewMessage;


            Messages.Add(new Message { Content = promptmsg, Role = "me" });
            prompt.Add(new Message { Content = promptmsg, Role = "user" });


            
            NewMessage = string.Empty;

            if (string.IsNullOrWhiteSpace(SelectedModel))
            {
                SelectedModel = "Phi-3.5-Instruct";
            }



            
            ChatRequest chatRequest = new ChatRequest
            {
                Model = SelectedModel,
                Messages = prompt
            };

            
            if(SelectedModel == "GPT-3.5-Finetuning")
            {
                var response = AOAIClient.ChatWithAOAI(promptmsg);
                Messages.Add(new Message { Content = response +  " [ Generated by "+SelectedModel + " ]" ,  Role = "bot" });
            }
            else
            {
                var response = await _slm.GeChatCompletionAsync(chatRequest);

                // Simulate bot response
                Messages.Add(new Message { Content =  response + " [ Generated by "+SelectedModel + " ]" , Role = "bot" });
            }
        }
    }

}
